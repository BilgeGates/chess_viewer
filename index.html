<!DOCTYPE html>
<html lang="az">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <title>Şahmat FEN Yükləyici</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: #1a1d29;
        min-height: 100vh;
        padding: 40px 24px;
        color: #e2e8f0;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      h1 {
        color: #ffffff;
        font-size: 2.25em;
        font-weight: 600;
        margin-bottom: 32px;
        letter-spacing: -0.5px;
      }

      .main-grid {
        display: grid;
        grid-template-columns: 1fr 420px;
        grid-template-rows: auto auto;
        gap: 20px;
        align-items: start;
      }

      .canvas-container {
        grid-column: 1;
        grid-row: 1;
      }

      .settings-panel {
        grid-column: 2;
        grid-row: 1 / 3;
      }

      .panel {
        background: #252936;
        border-radius: 8px;
        padding: 32px;
        border: 1px solid #333645;
      }

      .canvas-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
      }

      #chessboard {
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        image-rendering: -webkit-optimize-contrast;
        image-rendering: crisp-edges;
      }

      .buttons {
        display: grid;
        grid-template-columns: repeat(3, 1fr) repeat(2, 1fr);
        gap: 12px;
        width: 100%;
        max-width: 500px;
      }

      button {
        padding: 12px 20px;
        border: 1px solid #3d4153;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s ease;
        font-family: inherit;
        background: #2d3142;
        color: #e8eaf0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      button:hover {
        background: #363a4d;
        border-color: #4a4e63;
      }

      button:active {
        transform: scale(0.98);
      }

      button i {
        font-size: 14px;
      }

      .btn-primary {
        background: #3b7dd6;
        border-color: #3470c4;
        color: white;
      }

      .btn-primary:hover {
        background: #4489e0;
        border-color: #3d7dd1;
      }

      .btn-success {
        background: #10b981;
        border-color: #0ea472;
        color: white;
      }

      .btn-success:hover {
        background: #14c992;
        border-color: #10af7d;
      }

      .btn-warning {
        background: #f59e0b;
        border-color: #d97706;
        color: white;
      }

      .btn-warning:hover {
        background: #fbbf24;
        border-color: #f59e0b;
      }

      .form-group {
        margin-bottom: 24px;
      }

      label {
        display: block;
        font-weight: 500;
        margin-bottom: 10px;
        color: #cbd5e1;
        font-size: 14px;
      }

      textarea,
      select,
      input[type="number"],
      input[type="text"] {
        width: 100%;
        padding: 11px 13px;
        border: 1px solid #3d4153;
        border-radius: 6px;
        font-size: 13px;
        transition: all 0.15s ease;
        background: #1e212e;
        color: #e2e8f0;
      }

      textarea {
        font-family: "SF Mono", "Monaco", "Consolas", monospace;
        resize: vertical;
        min-height: 90px;
        line-height: 1.6;
      }

      select {
        font-family: inherit;
        cursor: pointer;
        font-weight: 500;
      }

      textarea:focus,
      select:focus,
      input:focus {
        outline: none;
        border-color: #3b7dd6;
        background: #252936;
      }

      input[type="number"] {
        font-family: "SF Mono", "Monaco", "Consolas", monospace;
        text-align: center;
        font-weight: 600;
      }

      input[type="number"]::-webkit-outer-spin-button,
      input[type="number"]::-webkit-inner-spin-button {
        appearance: none;
        -webkit-appearance: none;
        margin: 0;
      }

      input[type="number"] {
        appearance: textfield;
        -webkit-appearance: textfield;
        -moz-appearance: textfield;
      }

      .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      .grid-3 {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
      }

      .size-control {
        display: flex;
        gap: 12px;
        align-items: center;
      }

      .size-control input[type="range"] {
        flex: 1;
      }

      .size-control input[type="number"] {
        width: 100px;
        flex-shrink: 0;
      }

      .color-input {
        position: relative;
      }

      .color-input span {
        font-size: 13px;
        color: #94a3b8;
        font-weight: 500;
        margin-bottom: 8px;
        display: block;
      }

      .color-picker-wrapper {
        position: relative;
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 14px 16px;
        background: linear-gradient(135deg, #1e212e 0%, #252936 100%);
        border: 2px solid #3d4153;
        border-radius: 8px;
        transition: all 0.2s ease;
        cursor: pointer;
      }

      .color-picker-wrapper:hover {
        border-color: #4a5568;
        background: linear-gradient(135deg, #252936 0%, #2d3142 100%);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .color-preview {
        width: 44px;
        height: 44px;
        border-radius: 8px;
        border: 3px solid rgba(255, 255, 255, 0.1);
        flex-shrink: 0;
        transition: all 0.2s ease;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1),
          0 2px 8px rgba(0, 0, 0, 0.15);
      }

      .color-picker-wrapper:hover .color-preview {
        border-color: rgba(255, 255, 255, 0.2);
        transform: scale(1.08);
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.15),
          0 4px 12px rgba(0, 0, 0, 0.25);
      }

      .color-hex {
        font-family: "SF Mono", "Monaco", "Consolas", monospace;
        font-size: 14px;
        color: #e2e8f0;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      }

      input[type="color"] {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
        pointer-events: none;
      }

      input[type="range"] {
        width: 100%;
        height: 6px;
        border-radius: 3px;
        background: #2d3142;
        outline: none;
        cursor: pointer;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
      }

      input[type="range"]::-webkit-slider-thumb {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #3b7dd6;
        cursor: pointer;
        transition: background 0.15s ease;
      }

      input[type="range"]::-webkit-slider-thumb:hover {
        background: #4489e0;
        input[type="range"]::-moz-range-thumb {
          appearance: none;
          -moz-appearance: none;
          -webkit-appearance: none;
          width: 18px;
          height: 18px;
          border-radius: 50%;
          background: #3b7dd6;
          cursor: pointer;
          border: none;
        }
        border: none;
      }

      .preset-btn {
        padding: 11px 18px;
        background: #2d3142;
        border: 1px solid #3d4153;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.15s ease;
        font-size: 13px;
        font-weight: 500;
        font-family: inherit;
        color: #e2e8f0;
      }

      .preset-btn:hover {
        background: #363a4d;
        border-color: #4a4e63;
      }

      .checkbox-group {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
      }

      .checkbox-group input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
      }

      .checkbox-group label {
        margin: 0;
        cursor: pointer;
        font-size: 13px;
      }

      .error-message {
        color: #ef4444;
        font-size: 12px;
        margin-top: 8px;
        font-weight: 500;
        display: none;
      }

      .error-message.show {
        display: block;
      }

      .status-message {
        padding: 12px 16px;
        border-radius: 6px;
        text-align: center;
        font-weight: 500;
        font-size: 14px;
        margin-top: 16px;
        border: 1px solid;
      }

      .status-message.success {
        background: rgba(16, 185, 129, 0.15);
        color: #10b981;
        border-color: rgba(16, 185, 129, 0.3);
      }

      .status-message.error {
        background: rgba(239, 68, 68, 0.15);
        color: #ef4444;
        border-color: rgba(239, 68, 68, 0.3);
      }

      .status-message.hidden {
        display: none;
      }

      .info-section {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        padding: 18px 20px;
        border-radius: 8px;
        border-left: 4px solid #3b82f6;
        border-top: 1px solid #93c5fd;
        border-right: 1px solid #93c5fd;
        border-bottom: 1px solid #93c5fd;
        margin-top: 0;
      }

      .info-section h3 {
        font-size: 15px;
        color: #1e40af;
        margin-bottom: 10px;
        font-weight: 700;
      }

      .info-section p {
        font-size: 13px;
        color: #1e3a8a;
        line-height: 1.7;
        margin-bottom: 0;
      }

      .info-section strong {
        color: #1e40af;
        font-weight: 700;
      }

      @media (max-width: 600px) {
        .main-grid {
          grid-template-columns: 1fr;
          grid-template-rows: auto auto auto;
        }

        .canvas-container {
          grid-column: 1;
          grid-row: 1;
        }

        .info-panel {
          grid-column: 1;
          grid-row: 2;
        }

        .settings-panel {
          grid-column: 1;
          grid-row: 3;
        }

        h1 {
          font-size: 2em;
        }
      }

      @media (max-width: 768px) {
        body {
          padding: 24px 16px;
        }

        h1 {
          font-size: 1.75em;
          margin-bottom: 24px;
        }

        .panel {
          padding: 24px;
        }

        .buttons {
          grid-template-columns: 1fr;
        }

        .size-control {
          flex-direction: column;
        }

        .size-control input[type="number"] {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Şahmat FEN Yükləyici</h1>
      <div class="main-grid">
        <div class="panel canvas-container">
          <canvas id="chessboard"></canvas>

          <div class="buttons">
            <button class="btn-primary" onclick="downloadPNG()">
              <i class="fa-solid fa-download"></i>
              PNG
            </button>
            <button class="btn-warning" onclick="downloadJPEG()">
              <i class="fa-solid fa-download"></i>
              JPEG
            </button>
            <button class="btn-success" onclick="copyToClipboard()">
              <i class="fa-solid fa-copy"></i>
              Kopyala
            </button>
            <button onclick="flipBoard()">
              <i class="fa-solid fa-rotate"></i>
              Çevir
            </button>
            <button onclick="copyFEN()">
              <i class="fa-solid fa-clipboard"></i>
              FEN
            </button>
          </div>

          <div id="statusMessage" class="status-message hidden"></div>
        </div>

        <div class="panel settings-panel">
          <div class="form-group">
            <label>FEN</label>
            <textarea
              id="fenInput"
              oninput="onFENChange()"
              placeholder="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1"
            ></textarea>
          </div>

          <div class="form-group">
            <label>Fiqur Stili</label>
            <select id="pieceStyle" onchange="drawBoard()">
              <option value="cburnett">CBurnett (Chess.com)</option>
              <option value="merida">Merida (Lichess)</option>
              <option value="reillycraig">Reilly Craig</option>
              <option value="pirouetti">Pirouetti</option>
              <option value="chessnut">Chessnut</option>
              <option value="kosal">Kosal</option>
              <option value="fresca">Fresca</option>
              <option value="tatiana">Tatiana</option>
              <option value="alpha">Alpha</option>
              <option value="letter">Letter (Simpl)</option>
              <option value="cardinal">Cardinal</option>
              <option value="gioco">Gioco</option>
              <option value="icpieces">ICPieces</option>
            </select>
          </div>

          <div class="form-group">
            <label>Görünüş Parametrləri</label>
            <div class="checkbox-group">
              <input
                type="checkbox"
                id="showCoords"
                checked
                onchange="drawBoard()"
              />
              <label for="showCoords">Koordinatları göstər</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="showBorder" onchange="drawBoard()" />
              <label for="showBorder">Kənar çərçivə</label>
            </div>
          </div>

          <div class="form-group">
            <label>Hazır Pozisiyalar</label>
            <div class="grid-2">
              <button
                class="preset-btn"
                onclick="setFEN('rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1')"
              >
                Başlanğıc
              </button>
              <button
                class="preset-btn"
                onclick="setFEN('8/8/8/8/8/8/8/8 w - - 0 1')"
              >
                Boş Lövhə
              </button>
            </div>
          </div>

          <div class="form-group">
            <label>Lövhə Teması</label>
            <div class="grid-3">
              <button class="preset-btn" onclick="applyTheme('classic')">
                Klassik
              </button>
              <button class="preset-btn" onclick="applyTheme('green')">
                Yaşıl
              </button>
              <button class="preset-btn" onclick="applyTheme('blue')">
                Mavi
              </button>
              <button class="preset-btn" onclick="applyTheme('purple')">
                Bənövşəyi
              </button>
              <button class="preset-btn" onclick="applyTheme('wood')">
                Taxta
              </button>
              <button class="preset-btn" onclick="applyTheme('marble')">
                Mərmər
              </button>
            </div>
          </div>

          <div class="form-group">
            <label>Öz Rənglərini Seç</label>
            <div class="grid-2">
              <div class="color-input">
                <span>Açıq Xana</span>
                <div
                  class="color-picker-wrapper"
                  onclick="document.getElementById('lightSquare').click()"
                >
                  <div
                    class="color-preview"
                    id="lightPreview"
                    style="background: #f0d9b5"
                  ></div>
                  <div class="color-hex" id="lightHex">#F0D9B5</div>
                </div>
                <input
                  type="color"
                  id="lightSquare"
                  value="#f0d9b5"
                  oninput="updateColorPicker('light')"
                />
              </div>
              <div class="color-input">
                <span>Tünd Xana</span>
                <div
                  class="color-picker-wrapper"
                  onclick="document.getElementById('darkSquare').click()"
                >
                  <div
                    class="color-preview"
                    id="darkPreview"
                    style="background: #b58863"
                  ></div>
                  <div class="color-hex" id="darkHex">#B58863</div>
                </div>
                <input
                  type="color"
                  id="darkSquare"
                  value="#b58863"
                  oninput="updateColorPicker('dark')"
                />
              </div>
            </div>
          </div>

          <div class="form-group">
            <label>Lövhə Ölçüsü (200-600px)</label>
            <div class="size-control">
              <input
                type="range"
                id="boardSize"
                min="200"
                max="600"
                value="400"
                step="10"
                oninput="updateSizeFromSlider()"
              />
              <input
                type="number"
                id="customSize"
                min="200"
                max="600"
                value="400"
                oninput="updateSizeFromInput()"
              />
            </div>
            <div id="sizeError" class="error-message"></div>
          </div>

          <div class="form-group">
            <label>Export Keyfiyyəti</label>
            <select id="exportQuality">
              <option value="1">Standard (1x)</option>
              <option value="2" selected>Yüksək (2x)</option>
              <option value="3">Çox Yüksək (3x)</option>
              <option value="4">Maksimum (4x)</option>
            </select>
          </div>

          <div class="form-group">
            <label>Şəkil Adı</label>
            <input
              type="text"
              id="fileName"
              value="chess-position"
              placeholder="şəkil-adı"
            />
          </div>
        </div>
      </div>
    </div>

    <script>
      let flipped = false;
      let currentStyle = null;
      let boardState = [];
      let squareSize = 0;

      const canvas = document.getElementById("chessboard");
      const ctx = canvas.getContext("2d", { alpha: false });

      const pieceImages = {};
      const pieceMap = {
        K: "wK",
        Q: "wQ",
        R: "wR",
        B: "wB",
        N: "wN",
        P: "wP",
        k: "bK",
        q: "bQ",
        r: "bR",
        b: "bB",
        n: "bN",
        p: "bP",
      };

      // Keyboard shortcuts
      document.addEventListener("keydown", (e) => {
        if (e.ctrlKey && e.key === "c") {
          e.preventDefault();
          copyFEN();
        }
        if (e.ctrlKey && e.key === "v") {
          e.preventDefault();
          navigator.clipboard.readText().then((text) => {
            document.getElementById("fenInput").value = text;
            onFENChange();
          });
        }
        if (e.key === "f" || e.key === "F") {
          flipBoard();
        }
        if (e.key === "s" || e.key === "S") {
          e.preventDefault();
          downloadPNG();
        }
      });

      function getPieceBaseUrl(style) {
        return `https://lichess1.org/assets/piece/${style}/`;
      }

      function preloadPieces(style, callback) {
        Object.keys(pieceImages).forEach((k) => delete pieceImages[k]);

        const baseUrl = getPieceBaseUrl(style);
        let loaded = 0;
        const total = Object.keys(pieceMap).length;

        Object.keys(pieceMap).forEach((key) => {
          const img = new Image();
          img.crossOrigin = "anonymous";
          img.onload = () => {
            loaded++;
            if (loaded === total && callback) callback();
          };
          img.onerror = () => {
            loaded++;
            if (loaded === total && callback) callback();
          };
          img.src = `${baseUrl}${pieceMap[key]}.svg`;
          pieceImages[key] = img;
        });
      }

      const themes = {
        classic: { light: "#f0d9b5", dark: "#b58863" },
        green: { light: "#ffffdd", dark: "#86a666" },
        blue: { light: "#dee3e6", dark: "#8ca2ad" },
        purple: { light: "#e8c9d0", dark: "#b08ba2" },
        wood: { light: "#f0d0a0", dark: "#8b6f47" },
        marble: { light: "#e8e8e8", dark: "#999999" },
      };

      function parseFEN(fenString) {
        const parts = fenString.trim().split(/\s+/);
        const position = parts[0];

        const rows = position.split("/");
        if (rows.length !== 8) throw "FEN sətri 8 olmalıdır";

        const board = [];
        for (let row of rows) {
          let boardRow = [];
          for (let char of row) {
            if (isNaN(char)) {
              boardRow.push(char);
            } else {
              boardRow.push(...Array(parseInt(char)).fill(""));
            }
          }
          if (boardRow.length !== 8) throw "Hər sətirdə 8 xana olmalıdır";
          board.push(boardRow);
        }

        return board;
      }

      function drawBoard() {
        const boardSizeBase = parseInt(
          document.getElementById("boardSize").value
        );
        const showCoords = document.getElementById("showCoords").checked;
        const showBorder = document.getElementById("showBorder").checked;
        const pieceStyle = document.getElementById("pieceStyle").value;

        if (currentStyle !== pieceStyle) {
          currentStyle = pieceStyle;
          preloadPieces(pieceStyle, drawBoard);
          return;
        }

        const lightSquare = document.getElementById("lightSquare").value;
        const darkSquare = document.getElementById("darkSquare").value;

        const borderSize = showBorder ? 8 : 0;
        const boardSize = boardSizeBase + borderSize * 2;

        const pixelRatio = window.devicePixelRatio || 1;
        canvas.width = boardSize * pixelRatio;
        canvas.height = boardSize * pixelRatio;
        canvas.style.width = boardSize + "px";
        canvas.style.height = boardSize + "px";
        ctx.setTransform(1, 0, 0, 1, 0, 0);
        ctx.scale(pixelRatio, pixelRatio);

        squareSize = boardSizeBase / 8;

        if (showBorder) {
          ctx.fillStyle = "#1e212e";
          ctx.fillRect(0, 0, boardSize, boardSize);
        }

        try {
          const board = boardState;

          for (let row = 0; row < 8; row++) {
            for (let col = 0; col < 8; col++) {
              const isLight = (row + col) % 2 === 0;
              ctx.fillStyle = isLight ? lightSquare : darkSquare;
              const drawRow = flipped ? 7 - row : row;
              const drawCol = flipped ? 7 - col : col;

              ctx.fillRect(
                drawCol * squareSize + borderSize,
                drawRow * squareSize + borderSize,
                squareSize,
                squareSize
              );

              if (board[row] && board[row][col]) {
                const piece = board[row][col];
                const img = pieceImages[piece];
                if (img && img.complete) {
                  const center = getSquareCenter(row, col, borderSize);
                  ctx.drawImage(
                    img,
                    center.x - squareSize * 0.45,
                    center.y - squareSize * 0.45,
                    squareSize * 0.9,
                    squareSize * 0.9
                  );
                }
              }
            }
          }

          if (showCoords && squareSize >= 30) {
            const fontSize = squareSize * 0.22;
            const pad = squareSize * 0.08;

            ctx.font = `bold ${fontSize}px Arial`;
            ctx.textAlign = "left";
            ctx.textBaseline = "top";
            ctx.shadowBlur = squareSize * 0.05;

            for (let i = 0; i < 8; i++) {
              const rank = flipped ? i + 1 : 8 - i;
              ctx.fillText(
                rank,
                pad + borderSize,
                squareSize * i + pad + borderSize
              );

              const file = String.fromCharCode(97 + (flipped ? 7 - i : i));
              ctx.textAlign = "right";
              ctx.textBaseline = "bottom";
              ctx.fillText(
                file,
                squareSize * (i + 1) - pad + borderSize,
                boardSizeBase - pad + borderSize
              );

              ctx.textAlign = "left";
              ctx.textBaseline = "top";
            }

            ctx.shadowBlur = 0;
          }
        } catch (error) {
          ctx.fillStyle = "#ef4444";
          ctx.font = "bold 20px Arial";
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.fillText("FEN Xətası", boardSize / 2, boardSize / 2 - 15);
          ctx.font = "14px Arial";
          ctx.fillText(
            "Düzgün format daxil edin",
            boardSize / 2,
            boardSize / 2 + 10
          );
        }
      }

      function drawBoardToContext(ctxTarget) {
        const boardSizeBase = parseInt(
          document.getElementById("boardSize").value
        );
        const showCoords = document.getElementById("showCoords").checked;
        const showBorder = document.getElementById("showBorder").checked;

        const lightSquare = document.getElementById("lightSquare").value;
        const darkSquare = document.getElementById("darkSquare").value;

        const borderSize = showBorder ? 8 : 0;
        const square = boardSizeBase / 8;
        const fullSize = boardSizeBase + borderSize * 2;

        if (showBorder) {
          ctxTarget.fillStyle = "#1e212e";
          ctxTarget.fillRect(0, 0, fullSize, fullSize);
        }

        for (let row = 0; row < 8; row++) {
          for (let col = 0; col < 8; col++) {
            const isLight = (row + col) % 2 === 0;
            ctxTarget.fillStyle = isLight ? lightSquare : darkSquare;

            const drawRow = flipped ? 7 - row : row;
            const drawCol = flipped ? 7 - col : col;

            const x = drawCol * square + borderSize;
            const y = drawRow * square + borderSize;

            ctxTarget.fillRect(x, y, square, square);

            const piece = boardState[row]?.[col];
            if (piece) {
              const img = pieceImages[piece];
              if (img && img.complete) {
                ctxTarget.drawImage(
                  img,
                  x + square * 0.05,
                  y + square * 0.05,
                  square * 0.9,
                  square * 0.9
                );
              }
            }
          }
        }

        if (showCoords) {
          const fontSize = Math.max(10, square * 0.2);
          ctxTarget.font = `bold ${fontSize}px Arial`;
          ctxTarget.fillStyle = "rgba(0,0,0,0.8)";
          ctxTarget.textBaseline = "top";

          for (let i = 0; i < 8; i++) {
            const rank = flipped ? i + 1 : 8 - i;
            ctxTarget.fillText(
              rank,
              borderSize + square * 0.1,
              borderSize + square * i + square * 0.1
            );
          }

          ctxTarget.textBaseline = "bottom";
          for (let i = 0; i < 8; i++) {
            const file = String.fromCharCode(97 + (flipped ? 7 - i : i));
            ctxTarget.fillText(
              file,
              borderSize + square * (i + 1) - square * 0.15,
              borderSize + boardSizeBase - square * 0.1
            );
          }
        }
      }

      function getSquareCenter(row, col, borderSize = 0) {
        if (flipped) {
          row = 7 - row;
          col = 7 - col;
        }
        return {
          x: col * squareSize + squareSize / 2 + borderSize,
          y: row * squareSize + squareSize / 2 + borderSize,
        };
      }

      function updateColorPicker(type) {
        const input = document.getElementById(`${type}Square`);
        const preview = document.getElementById(`${type}Preview`);
        const hex = document.getElementById(`${type}Hex`);

        const color = input.value.toUpperCase();
        preview.style.background = color;
        hex.textContent = color;

        drawBoard();
        saveState();
      }

      function flipBoard() {
        flipped = !flipped;
        drawBoard();
        showStatus("Lövhə çevrildi", "success");
      }

      function updateSizeFromSlider() {
        const size = parseInt(document.getElementById("boardSize").value);
        document.getElementById("customSize").value = size;
        hideError();
        drawBoard();
        saveState();
      }

      function updateSizeFromInput() {
        const input = document.getElementById("customSize");
        const slider = document.getElementById("boardSize");
        const size = parseInt(input.value);

        if (isNaN(size) || input.value === "") {
          return;
        }

        if (size < 200 || size > 600) {
          showError("Ölçü 200-600px arasında olmalıdır");
          return;
        }

        hideError();
        slider.value = size;
        drawBoard();
        saveState();
      }

      function showError(message) {
        const errorDiv = document.getElementById("sizeError");
        errorDiv.textContent = message;
        errorDiv.classList.add("show");
      }

      function hideError() {
        const errorDiv = document.getElementById("sizeError");
        errorDiv.classList.remove("show");
      }

      function setFEN(fen) {
        document.getElementById("fenInput").value = fen;
        boardState = parseFEN(fen);
        drawBoard();
        saveState();
      }

      function applyTheme(themeName) {
        const theme = themes[themeName];
        document.getElementById("lightSquare").value = theme.light;
        document.getElementById("darkSquare").value = theme.dark;
        updateColorPicker("light");
        updateColorPicker("dark");
        drawBoard();
        saveState();
      }

      function getFileName() {
        const name =
          document.getElementById("fileName").value || "chess-position";
        return name.replace(/[^a-zA-Z0-9-_]/g, "-");
      }

      function downloadPNG() {
        const notReady = Object.values(pieceImages).some(
          (img) => !img.complete
        );
        if (notReady) {
          showStatus("Fiqurlar yüklənir, bir az gözlə", "error");
          return;
        }
        const quality = parseInt(
          document.getElementById("exportQuality").value
        );
        const boardSizeBase = parseInt(
          document.getElementById("boardSize").value
        );
        const showBorder = document.getElementById("showBorder").checked;
        const borderSize = showBorder ? 8 : 0;

        const exportSize = (boardSizeBase + borderSize * 2) * quality;

        const exportCanvas = document.createElement("canvas");
        const exportCtx = exportCanvas.getContext("2d");

        exportCanvas.width = exportSize;
        exportCanvas.height = exportSize;

        exportCtx.scale(quality, quality);

        drawBoardToContext(exportCtx, quality);

        const link = document.createElement("a");
        link.download = `${getFileName()}.png`;
        link.href = exportCanvas.toDataURL("image/png", 1.0);
        link.click();

        showStatus("PNG yüksək keyfiyyətlə yükləndi", "success");
      }

      function downloadJPEG() {
        const quality = parseInt(
          document.getElementById("exportQuality").value
        );
        const size = parseInt(document.getElementById("boardSize").value);
        const border = document.getElementById("showBorder").checked ? 8 : 0;

        const exportCanvas = document.createElement("canvas");
        const exportCtx = exportCanvas.getContext("2d");

        exportCanvas.width = (size + border * 2) * quality;
        exportCanvas.height = (size + border * 2) * quality;

        exportCtx.scale(quality, quality);

        exportCtx.fillStyle = "#ffffff";
        exportCtx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);

        drawBoardToContext(exportCtx);

        const link = document.createElement("a");
        link.download = `${getFileName()}.jpg`;
        link.href = exportCanvas.toDataURL("image/jpeg", 0.95);
        link.click();

        showStatus("JPEG yüksək keyfiyyətlə yükləndi", "success");
      }

      async function copyToClipboard() {
        try {
          const quality = parseInt(
            document.getElementById("exportQuality").value
          );
          const baseSize = parseInt(document.getElementById("boardSize").value);
          const border = document.getElementById("showBorder").checked ? 8 : 0;
          const fullSize = baseSize + border * 2;

          tempCanvas.width = fullSize * quality;
          tempCanvas.height = fullSize * quality;

          tempCtx.scale(quality, quality);
          drawBoardToContext(tempCtx);

          const blob = await new Promise((resolve) =>
            tempCanvas.toBlob(resolve, "image/png", 1.0)
          );
          await navigator.clipboard.write([
            new ClipboardItem({ "image/png": blob }),
          ]);
          showStatus("Şəkil kopyalandı!", "success");
        } catch (err) {
          showStatus("Kopyalama xətası!", "error");
        }
      }

      async function copyFEN() {
        try {
          const fen = document.getElementById("fenInput").value;
          await navigator.clipboard.writeText(fen);
          showStatus("FEN kopyalandı!", "success");
        } catch (err) {
          showStatus("FEN kopyalama xətası!", "error");
        }
      }

      function showStatus(message, type) {
        const status = document.getElementById("statusMessage");
        status.textContent = message;
        status.className = `status-message ${type}`;
        setTimeout(() => hideStatus(), 3000);
      }

      function hideStatus() {
        document.getElementById("statusMessage").className =
          "status-message hidden";
      }

      function onFENChange() {
        try {
          boardState = parseFEN(fenInput.value);
          drawBoard();
          saveState();
        } catch (e) {
          drawBoard();
        }
      }

      function saveState() {
        try {
          const sizeInput = document.getElementById("customSize");
          const size = parseInt(sizeInput.value);

          if (!isNaN(size) && size >= 200 && size <= 600) {
            localStorage.setItem(
              "fen",
              document.getElementById("fenInput").value
            );
            localStorage.setItem(
              "style",
              document.getElementById("pieceStyle").value
            );
            localStorage.setItem(
              "light",
              document.getElementById("lightSquare").value
            );
            localStorage.setItem(
              "dark",
              document.getElementById("darkSquare").value
            );
            localStorage.setItem("size", size);
            localStorage.setItem(
              "showCoords",
              document.getElementById("showCoords").checked
            );
            localStorage.setItem(
              "showBorder",
              document.getElementById("showBorder").checked
            );
            localStorage.setItem(
              "quality",
              document.getElementById("exportQuality").value
            );
            localStorage.setItem(
              "fileName",
              document.getElementById("fileName").value
            );
          }
        } catch (e) {
          console.error("Yadda saxlama xətası:", e);
        }
      }

      function loadState() {
        try {
          if (localStorage.getItem("fen"))
            fenInput.value = localStorage.getItem("fen");
          if (localStorage.getItem("style"))
            pieceStyle.value = localStorage.getItem("style");
          if (localStorage.getItem("light")) {
            lightSquare.value = localStorage.getItem("light");
            updateColorPicker("light");
          }
          if (localStorage.getItem("dark")) {
            darkSquare.value = localStorage.getItem("dark");
            updateColorPicker("dark");
          }
          if (localStorage.getItem("size")) {
            const size = localStorage.getItem("size");
            boardSize.value = size;
            customSize.value = size;
          }
          if (localStorage.getItem("showCoords"))
            showCoords.checked = localStorage.getItem("showCoords") === "true";
          if (localStorage.getItem("showBorder"))
            showBorder.checked = localStorage.getItem("showBorder") === "true";
          if (localStorage.getItem("quality"))
            exportQuality.value = localStorage.getItem("quality");
          if (localStorage.getItem("fileName"))
            fileName.value = localStorage.getItem("fileName");
        } catch (e) {
          console.error("Yükləmə xətası:", e);
        }
      }

      loadState();
      boardState = parseFEN(
        fenInput.value ||
          "rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1"
      );
      drawBoard();
    </script>
  </body>
</html>
